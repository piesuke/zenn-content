---
title: "ウズスタジオの技術構成" # 記事のタイトル
emoji: "😸" # アイキャッチとして使われる絵文字（1文字だけ）
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: ["React", "MongoDB", "Quill", "zustand"] # タグ。["markdown", "rust", "aws"]のように指定する
published: false # 公開設定（falseにすると下書き）
---

こんにちは。Sally 社エンジニアの [@piesuke](https://x.com/piesuke27)です。

私たちは、マーダーミステリーを遊べることが出来るアプリ「ウズ」と、マーダーミステリーを制作してウズ上で遊べることが出来るアプリ「ウズスタジオ」を開発しています。

今回は、ウズスタジオの技術構成について紹介します。

## サービス紹介

ウズスタジオとは、マーダーミステリー制作に特化したエディターツールです。
マーダーミステリー特化と謳っていますが、最近は謎解きやボードゲームなど、様々なゲームを制作することが出来るようになっています。

シナリオの制作以外にも、以下のような機能があります。

- 公開したシナリオの分析
- 売上の確認・申請
- メンバーの権限管理

このうち、シナリオ制作機能とそれ以外では技術スタックが大きく異なるので、今回はシナリオ制作機能の構成について紹介します。

## アーキテクチャ全体像

![](/images/studio-architecture.png)

ウズスタジオは、ウズ上で遊べるシナリオを制作するためのツールです。シナリオデータは最終的に Google Cloud Storage に JSON 形式で保存され、ウズがそのデータを取得してユーザーに表示しています。

詳しい技術構成は以下の通りです。

- フロントエンド

  - Next.js / TypeScript

- バックエンド

  - Next.js API Routes
  - Node.js
  - GKE (Google Kubernetes Engine)

- データベース

  - MongoDB

- ホスティング

  - Vercel

- アセット管理
  - Google Cloud Storage
- 認証
  - Firebase Authentication

## データベース

ウズのシナリオデータは JSON 形式で保存されています。JSON を扱いやすいデータベースを選定するため、以下の NoSQL データベースを検討しました。

- Firestore
- DynamoDB
- MongoDB

最終的に、クエリの柔軟性や豊富なデータ型を持つ MongoDB を採用しました。MongoDB Atlas を利用することで、クラウド上での運用も容易で、運用コストを抑えることができます。

## フロントエンド (Next.js / TypeScript)

Next.js アプリケーションは Vercel でホスティングされています。自社の他サービスも Next.js で構築されているため、知見が蓄積されており、効率的な開発が可能です。

開発当初は App Router がリリースされておらず、基本的に CSR で完結するため現在も Page Router を使用しています。最近では App Router への移行も検討しています。

### 状態管理

マーダーミステリー制作の特徴として、条件分岐や複雑なギミックが多いことが挙げられます。
例えば、エンディングに遷移する時に特定のアイテムを持っているかどうか、特定の選択肢に投票しているかどうかなど、様々な条件を加味してエンディングを決定する必要があります。
そのような条件を設定する時には、json から様々なデータを取得して状態を管理する必要があります。ですので、グローバルな状態管理が必須になります。

状態管理サービスは、初めは context API を使っていましたが、コードが煩雑になってきたり、パフォーマンスの問題に直面したので zustand に乗り換えました。

状態管理ライブラリはかなり存在し、実際に Redux や recoil なども検討しましたが、結局 zustand を採用しました。理由は以下の通りです。

- 開発者が元々 Redux を使っていたので、思想が似ている zustand は学習コストが低い
- Redux はコードが煩雑になりがちなので、よりシンプルに使える zustand の方が適していた
- ライブラリが軽量である

zustand の使い所としては、シナリオデータの取得と UI に表示する際の加工です。
シナリオデータを全て取得した後、キャラクターや手がかりなどのデータを取り出して、必要なデータだけを取り出して UI に表示するような処理を行っています。
また、フェーズを表示する際に、一覧として表示したりフローチャート風に表示したりしているのですが、そのようなデータの加工は selector を使ってメモ化することでパフォーマンスを向上させています。

## バックエンド部分

元々は API Routes を使用していましたが、シナリオデータの肥大化により GKE に移行しました。

ウズのシナリオデータは柔軟なスキーマを持っており、そのままでは開発が難しいため、一部のデータ構造を MongoDB に保存し、必要な形式に変換しています。この変換処理が肥大化し、Vercel の制限に引っかかることがあったため、GKE に移行しました。

また、MongoDB の Change Streams を利用して、データの変更をリアルタイムで取得し UI を更新しています。以前は realm というライブラリを使用していましたが、Chrome の特定バージョンでクラッシュする問題が発生したため、GKE に移行しました。GKE では Node.js サーバーを立て、Socket.io を使ってリアルタイム通信を行っています。

## アセット管理

マーダーミステリー制作では、画像や音声などのアセットが必要になります。そのため、Google Cloud Storage を使用してアセットを管理しています。
セキュリティの観点から署名付き URL を使用して、アセットのアップロードやダウンロードを行っています。

## 認証

Firebase Authentication を使用しています。ウズとウズスタジオの両方での認証を統一するため、Firebase Authentication を採用しました。
認証部分だけを切り出してパッケージ化することで、弊社の他の Web サービスでも利用できるようにしています。

## まとめ

シナリオ制作ツールという珍しいサービスを開発しているため、あまり知見が転がってないような課題に直面することも多いですが、それが逆に楽しいところでもあります。
また、複雑なデータ構造をどう分かりやすくユーザーに見せて、簡単に開発してもらうかという UX の部分も非常に重要になってきます。
